
# ğŸš‡ E-Ticketing System

Sistem ini adalah simulasi **E-Ticketing Transportasi Publik** yang mendukung:
- **Check-in / Check-out** kartu pada gate.
- **Sinkronisasi offline** saat device tidak terkoneksi internet.
- **Validasi trip dan saldo** secara real-time (online) maupun batch (offline).
- **Konfigurasi device & manajemen tarif**.

---

## ğŸ“‚ Struktur Database

### Tabel Utama
- **users** â†’ menyimpan akun admin/operator.
- **stations** â†’ daftar stasiun.
- **devices** â†’ gate device pada stasiun.
- **cards** â†’ kartu penumpang (saldo, status, counter).
- **fares** â†’ tarif perjalanan antar stasiun.
- **trips** â†’ perjalanan kartu (entry-exit).
- **transactions** â†’ detail transaksi kartu di gate.
- **sync_logs** â†’ log sinkronisasi transaksi offline.

### Contoh Data Dummy

#### users
| id | username | role | fullname |
|----|----------|------|----------|
| 1 | admin | admin | Administrator |
| 2 | gateop1 | operator | Gate Operator 1 |

#### stations
| id | station_id | name |
|----|------------|------|
| 1 | ST01 | Stasiun A |
| 2 | ST02 | Stasiun B |
| 3 | ST03 | Stasiun C |

#### cards
| card_id | balance | status | txn_counter |
|---------|---------|--------|-------------|
| CARD101 | 20000   | ACTIVE | 1000 |
| CARD102 | 15000   | ACTIVE | 2000 |

#### fares
| from | to | amount |
|------|----|--------|
| ST01 | ST02 | 3000 |
| ST01 | ST03 | 6000 |
---

## ğŸ“Š Flowchart

![Flowchart](flowchart.png)

### Penjelasan:
1. Penumpang tap kartu di gate.
2. Gate cek apakah **online**:
   - âœ… **Online** â†’ request dikirim ke **Central API** â†’ validasi saldo, blacklist, trip â†’ database update â†’ gate terbuka / tolak akses.
   - âŒ **Offline** â†’ validasi lokal + update saldo on-card â†’ gate terbuka â†’ transaksi disimpan lokal â†’ tunggu internet â†’ batch sync ke server.

---

## ğŸ§© Sequence Diagram

### 1. Online Check-in
![Online Sequence](sequence-online-checking.png)

**Alur:**
1. Kartu ditap di gate.
2. Edge device kirim request ke Central API (`/tap/checkin`).
3. API validasi kartu, trip, counter, blacklist.
4. Jika valid â†’ gate terbuka, trip tersimpan, saldo terupdate.  
   Jika invalid â†’ akses ditolak.

---

### 2. Offline Checkout + Sync
![Offline Sequence](sequence-offline-checking.png)

**Alur:**
1. Kartu ditap saat gate offline.
2. Edge device hitung tarif lokal, update saldo on-card, simpan transaksi `SYNC_PENDING`.
3. Gate terbuka.
4. Setelah koneksi internet kembali â†’ transaksi batch dikirim (`/sync/batch`).
5. Central API validasi & update trip + saldo.
6. Transaksi diberi status `SYNCED` atau `FAILED`.

---

## âš™ï¸ API Endpoint (Swagger)

- `POST /login` â†’ login user (JWT).
- `POST /stations` â†’ tambah stasiun.
- `POST /tap/checkin` â†’ proses check-in.
- `POST /tap/checkout` â†’ proses check-out.
- `POST /sync/batch` â†’ upload log offline.
- `GET /config/{deviceId}` â†’ ambil konfigurasi device.

---

## ğŸ“ Ringkasan
- **Online mode** â†’ transaksi langsung divalidasi di server.
- **Offline mode** â†’ transaksi disimpan lokal, lalu disinkronisasi saat online.
- **Proteksi**: `txn_counter` mencegah replay/duplikasi transaksi.
- **Rekonsiliasi** memastikan saldo & trip konsisten antara kartu, device, dan server.
